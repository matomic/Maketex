#SHELL    = bash
include maketex_defs.mk # common make defs for my various latex projects

### Identify LaTeX mater file by \documentclass
MASTER  = "^\\\\documentclass"
MAINTEXSRC = $(shell grep -l $(MASTER) *.tex)
PDFOUT  = $(MAINTEXSRC:%.tex=%.pdf)
# The variable MAINBIB if define is used to generate a partial bibliography exactly equal to the need of this project from my master library. Perhaps should grep from source in the future
MAINBIB = bibliography.bib

### For each master file BASE.tex, define variables BASE_deps, BASE_texs, BASE_bibs, BASE_figs, BASE_vector, BASE_raster that holds its requisites.
rmsuffix=$(1:%$(suffix $1)=%)
define texallchildren
$1_texs := $(call texdeepinclude,$1)
endef
define texauxiliaries
$(foreach x,$1 $(value $1_texs),
$1_bibs += $(call includedbibs,$x)
$1_figs += $(call includedfigs,$x))
endef
# divide figs further up between vector and raster graphics
define texdeps_all
$1_vector = $(filter %.eps %.pdf,$(value $1_figs))
$1_raster = $(filter %.png %.jpg,$(value $1_figs))
$1_deps   = $(strip $1 $(value $1_texs) $(value $1_bibs) $(value $1_figs))
endef
#
$(foreach x,$(MAINTEXSRC),                           \
	$(eval $(call texallchildren,$(x)))              \
	$(eval $(call texauxiliaries,$(x)))              \
	$(eval $(call texdeps_all,$(x))))

.PHONY : all clean pkg info

# ALL
all : $(PDFOUT)
###$(PDFOUT:pdf=bib)

depinfo:
	@printf ">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\n"
	@printf "%s << %s\n  \
$(EGRN)incl files$(ERST)  : %s\n  \
$(EGRN)Bib files$(ERST)   : %s\n  \
$(EGRN)Vector figs$(ERST) : %s\n  \
$(EGRN)Raster figs$(ERST) : %s\n  \
$(EGRN)Everything$(ERST)  : %s\n\
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\
\n" $(foreach x, $(MAINTEXSRC),                           \
"$(x:%.tex=%.pdf)" "$x"                                \
"$(filter-out $x,$(value $x_texs))" \
"$(value $x_bibs)"                     \
"$(sort $(value $x_vector))"             \
"$(sort $(value $x_raster))"             \
"$(value $x_deps)")
	$(foreach x,$(MAINTEXSRC), \
$(call sh_auxlist,$x $(value $x_texs));)
	$(foreach x,$(MAINTEXSRC), \
$(call sh_auxlist_2,$x $(value $x_texs));)

# $(foreach x,$(MAINTEXSRC) introduction.tex, \
$(call sh_echo_tex_cmd_args,$x,includegraphics,eps pdf jpg png,eps pdf);)
pkg : $(PDFOUT) $(PDFOUT:pdf=zip)

## If main bib
ifdef MAINBIB
BIBPROG = mkBiBfTeX.py
RUNBIB  = python $(BIBPROG)
%.bib : %.tex $(MAINBIB) $(BIBPROG)
	@$(call sh_cprun,mkBiBfTex.py,$?,$@);
	@( $(RUNBIB) $^ > _$@ ) && mv _$@ $@ || rm _$@
endif

LAUNDARY=*.aux *.out *.log *.bbl *.blg *.bak $(PDFOUT)
clean :
	rm -f $(LAUNDARY);
